<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Vibe Coding MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0d1117; --panel:#161b22; --border:#30363d; --accent:#2563eb; --text:#e6edf3; --muted:#8b949e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen; background:var(--bg); color:var(--text); height:100vh; display:flex; }
    .column { padding:16px; overflow:auto; }
    .left { width:42%; border-right:1px solid var(--border); display:flex; flex-direction:column; }
    .right { flex:1; display:flex; flex-direction:column; }
    h1 { margin:0 0 12px; font-size:18px; font-weight:600; }
    #messages { flex:1; overflow-y:auto; padding:8px; border:1px solid var(--border); border-radius:6px; background:var(--panel); font-size:14px; }
    .msg { margin-bottom:12px; line-height:1.4; white-space:pre-wrap; word-break:break-word; }
    .role { font-weight:600; margin-right:4px; }
    form { margin-top:12px; display:flex; gap:8px; }
    textarea { flex:1; resize:vertical; min-height:60px; background:#0f151c; color:var(--text); border:1px solid var(--border); border-radius:6px; padding:8px; font-family:inherit; font-size:14px; }
    button { background:var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    #status { font-size:12px; color:var(--muted); margin-top:6px; height:16px; }
    .preview-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    iframe { flex:1; width:100%; border:1px solid var(--border); background:#fff; border-radius:6px; }
    #diff { margin-top:8px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; white-space:pre; overflow:auto; max-height:160px; border:1px solid var(--border); padding:8px; border-radius:6px; background:#0f151c; }
    .tag { background:#1e293b; padding:2px 6px; font-size:11px; border-radius:4px; margin-left:6px; }
    .msg.assistant { border-left:3px solid var(--accent); padding-left:8px; }
  </style>
</head>
<body>
  <div class="column left">
    <h1>Chat / 指令</h1>
    <div id="messages"></div>
    <form id="chat-form">
      <textarea id="input" placeholder="描述你想要的页面或修改，如：添加一个暗色导航栏..."></textarea>
      <div style="display:flex; flex-direction:column; gap:4px; width:140px;">
        <button type="submit">发送</button>
        <label style="font-size:11px; display:flex; gap:4px; align-items:center; cursor:pointer;">
          <input type="checkbox" id="streamToggle" /> 流式
        </label>
        <label style="font-size:11px; display:flex; gap:4px; align-items:center; cursor:pointer;">
          <input type="checkbox" id="rawToggle" /> 原始输出
        </label>
      </div>
    </form>
    <div id="status"></div>
    <div style="margin-top:4px; font-size:12px; color:var(--muted);">
      首次会自动创建 session。返回代码会完全替换右侧预览。
    </div>
  </div>
  <div class="column right">
    <div class="preview-header">
      <h1 style="margin:0; font-size:16px;">预览 <span class="tag" id="sessionTag">...</span></h1>
      <button id="downloadBtn" style="background:#334155;">下载HTML</button>
    </div>
    <iframe id="preview" title="preview"></iframe>
    <div id="diff" hidden></div>
  </div>

<script>
const API_BASE = localStorage.getItem('vc_api_base') || 'http://115.190.179.122:80';
let sessionId = null;
let lastCode = '';
const messagesEl = document.getElementById('messages');
const form = document.getElementById('chat-form');
const input = document.getElementById('input');
const statusEl = document.getElementById('status');
const iframe = document.getElementById('preview');
const diffEl = document.getElementById('diff');
const sessionTag = document.getElementById('sessionTag');
const downloadBtn = document.getElementById('downloadBtn');

function addMessage(role, content) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  div.innerHTML = `<span class="role">${role === 'user' ? '你' : 'Agent'}</span>${escapeHtml(content)}`;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return div;
}

function escapeHtml(str){
  return str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','\"':'&quot;'}[c]));
}

async function createSession() {
  status('创建会话...');
  const r = await fetch(`${API_BASE}/sessions`, {method:'POST'});
  if(!r.ok) throw new Error('创建会话失败');
  const data = await r.json();
  sessionId = data.session_id;
  sessionTag.textContent = sessionId.slice(0,8);
  status('会话已就绪');
}

function status(msg){ statusEl.textContent = msg || ''; }

async function sendMessage(text){
  if(!sessionId) await createSession();
  const userDiv = addMessage('user', text);
  const assistantDiv = addMessage('assistant', '处理中...');
  status('生成中...');
  form.querySelector('button').disabled = true;
  input.disabled = true;
  const useStream = document.getElementById('streamToggle')?.checked;
  if(useStream){
    return sendMessageStream(text, assistantDiv);
  }
  try {
    const r = await fetch(`${API_BASE}/sessions/${sessionId}/messages`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({message: text})
    });
    if(!r.ok){
      let detail = '错误';
      try { const j = await r.json(); detail = j.detail || JSON.stringify(j); } catch{}
      assistantDiv.innerHTML = `<span class='role'>Agent</span>失败: ${escapeHtml(detail)}`;
      status('失败');
      return;
    }
    const data = await r.json();
    assistantDiv.innerHTML = `<span class='role'>Agent</span>${escapeHtml(document.getElementById('rawToggle')?.checked ? (data.assistant_message_raw||data.assistant_message) : '已完成，右侧已更新预览')}`;
    updatePreview(data.code);
    showDiff(data.diff);
    status('完成');
  } catch(e){
    assistantDiv.innerHTML = `<span class='role'>Agent</span>异常: ${escapeHtml(e.message)}`;
    status('异常');
  } finally {
    form.querySelector('button').disabled = false;
    input.disabled = false;
    input.value='';
    input.focus();
  }
}

function buildWsUrl(path){
  if(API_BASE.startsWith('https://')) return API_BASE.replace('https://','wss://') + path;
  if(API_BASE.startsWith('http://')) return API_BASE.replace('http://','ws://') + path;
  return 'ws://' + API_BASE + path;
}

async function sendMessageStream(text, assistantDiv){
  const rawToggle = document.getElementById('rawToggle');
  let rawBuffer='';
  try {
    const url = buildWsUrl(`/ws/sessions/${sessionId}`);
    const ws = new WebSocket(url);
    let finished = false;
    ws.onopen = () => ws.send(JSON.stringify({type:'user_message', message:text}));
    ws.onmessage = (ev) => {
      let msg; try { msg = JSON.parse(ev.data); } catch { return; }
      switch(msg.type){
        case 'ack': break;
        case 'token':
          rawBuffer += msg.text;
          if(rawToggle.checked){ assistantDiv.innerHTML = `<span class='role'>Agent</span>${escapeHtml(rawBuffer)}`; }
          break;
        case 'assistant_message_complete':
          if(!rawToggle.checked){ assistantDiv.innerHTML = `<span class='role'>Agent</span>生成完成`; }
          break;
        case 'code': updatePreview(msg.code); break;
        case 'diff': showDiff(msg.diff); break;
        case 'final':
          finished = true; status('完成');
          form.querySelector('button').disabled=false; input.disabled=false; input.value=''; input.focus();
          ws.close();
          break;
        case 'error':
          assistantDiv.innerHTML = `<span class='role'>Agent</span>错误: ${escapeHtml(msg.detail||'')}`;
          status('错误');
          form.querySelector('button').disabled=false; input.disabled=false;
          ws.close();
          break;
      }
    };
    ws.onerror = () => {
      if(!rawBuffer){ assistantDiv.innerHTML = `<span class='role'>Agent</span>连接错误`; }
      status('连接错误');
      form.querySelector('button').disabled=false; input.disabled=false;
    };
    ws.onclose = () => { if(!finished){ status('中断'); form.querySelector('button').disabled=false; input.disabled=false; } };
  } catch(e){
    assistantDiv.innerHTML = `<span class='role'>Agent</span>异常: ${escapeHtml(e.message)}`;
    status('异常');
    form.querySelector('button').disabled=false; input.disabled=false;
  }
}

function updatePreview(code){
  lastCode = code;
  iframe.srcdoc = code;
}

function showDiff(diff){
  if(diff && diff.trim()){
    diffEl.hidden = false;
    diffEl.textContent = diff;
  } else {
    diffEl.hidden = true;
    diffEl.textContent='';
  }
}

form.addEventListener('submit', e => {
  e.preventDefault();
  const text = input.value.trim();
  if(!text) return;
  sendMessage(text);
});

downloadBtn.addEventListener('click', () => {
  if(!lastCode) return;
  const blob = new Blob([lastCode], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'index.html';
  a.click();
  URL.revokeObjectURL(a.href);
});

// Auto-create session on load (ignore errors; lazily retried if needed)
createSession().catch(()=>status('待发送第一条指令后再试'));
</script>
</body>
</html>
